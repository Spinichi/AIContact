<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <title>Chat Test</title>
</head>
<body>
<h2>1:1 Chat Test</h2>

<!-- 입력 영역 -->
<div>
    <label>Room ID: </label>
    <input id="roomId" placeholder="roomId 입력" value="1234"/>
</div>
<div>
    <label>Sender ID: </label>
    <input id="senderId" placeholder="senderId 입력" value="1"/>
</div>
<div>
    <label>Couple ID: </label>
    <input id="coupleId" placeholder="coupleId 입력" value="1"/>
</div>

<div style="margin-top:8px;">
    <button id="connectBtn">Connect</button>
</div>

<!-- 채팅 메시지 표시 영역 -->
<div id="messages" style="border:1px solid #ccc; padding:10px; height:200px; width:300px; overflow:auto; margin-top:16px;">
</div>

<!-- 텍스트 메시지 전송 -->
<div style="margin-top:8px;">
    <input id="msgInput" placeholder="메시지 입력" style="width:220px;"/>
    <button id="sendBtn">Send</button>
</div>

<!-- 이미지 업로드 -->
<div style="margin-top:8px;">
    <input type="file" id="imgInput" accept="image/*" />
    <button id="uploadBtn">Send Image</button>
</div>

<!-- 자바스크립트 -->
<script>
    let stompClient;

    // WebSocket 연결
    document.getElementById('connectBtn').onclick = () => {
        const roomId = parseInt(document.getElementById('roomId').value.trim(), 10);
        if (!roomId) return alert('Room ID를 입력하세요.');

        const socket = new SockJS('/api/v1/ws-chat');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, frame => {
            console.log('Connected:', frame);
            document.getElementById('messages').innerHTML = '';

            stompClient.subscribe(`/sub/chat/${roomId}`, msg => {
                const chat = JSON.parse(msg.body);
                const div = document.createElement('div');

                if (chat.messageType === 'IMAGE') {
                    const img = document.createElement('img');
                    img.src = chat.content;
                    img.style.maxWidth = '200px';
                    div.innerHTML = `[${chat.sentAt}] ${chat.senderId}:<br/>`;
                    div.appendChild(img);
                } else {
                    div.textContent = `[${chat.sentAt}] ${chat.senderId}: ${chat.content}`;
                }

                document.getElementById('messages').appendChild(div);
                document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
            });
        }, error => {
            console.error('WebSocket error', error);
            alert('WebSocket 연결에 실패했습니다.');
        });
    };

    // 텍스트 메시지 전송
    document.getElementById('sendBtn').onclick = () => {
        if (!stompClient) return alert('먼저 Connect 버튼을 눌러 연결하세요.');

        const roomId = parseInt(document.getElementById('roomId').value.trim(), 10);
        const senderId = parseInt(document.getElementById('senderId').value.trim(), 10);
        const content  = document.getElementById('msgInput').value.trim();

        if (!content) return alert('메시지를 입력하세요.');

        const payload = {
            roomId: roomId,
            senderId: senderId,
            content: content,
            messageType: "TEXT"
        };

        stompClient.send('/pub/chat/sendMessage', {}, JSON.stringify(payload));
        document.getElementById('msgInput').value = '';
    };

    // 이미지 전송
    document.getElementById('uploadBtn').onclick = async () => {
        const file = document.getElementById('imgInput').files[0];
        if (!file) return alert('이미지를 선택하세요.');

        const coupleId = document.getElementById('coupleId').value.trim();
        const senderId = document.getElementById('senderId').value.trim();
        const roomId = document.getElementById('roomId').value.trim();

        const formData = new FormData();
        formData.append('file', file);

        try {
            const res = await fetch(`/api/v1/media/images?coupleId=${coupleId}&uploaderId=${senderId}`, {
                method: 'POST',
                body: formData
            });

            if (!res.ok) {
                const text = await res.text();
                throw new Error(`HTTP ${res.status}: ${text}`);
            }

            const data = await res.json();
            const imageUrl = data.fileUrl;

            const payload = {
                roomId: parseInt(roomId),
                senderId: parseInt(senderId),
                content: imageUrl,
                messageType: 'IMAGE'
            };

            stompClient.send('/pub/chat/sendMessage', {}, JSON.stringify(payload));
        } catch (err) {
            console.error('이미지 업로드 실패:', err);
            alert('이미지 업로드 실패: ' + err.message);
        }
    };
</script>
</body>
</html>
